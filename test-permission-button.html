<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permission Button Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <div class="container mt-4">
        <h1>Permission Button Test</h1>
        
        <div id="permission-alert" class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="fas fa-exclamation-triangle me-3"></i>
            <div class="flex-grow-1">
                <div class="fw-bold">Device Permissions Required</div>
                <div class="small">UltiBiker needs Bluetooth and ANT+ permissions to detect cycling sensors.</div>
            </div>
            <div class="ms-3">
                <button type="button" class="btn btn-success btn-sm me-2" id="requestBluetoothBtn">
                    <i class="fas fa-shield-alt me-1"></i>Grant Permission
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="checkPermissionsBtn">
                    <i class="fas fa-sync me-1"></i>Check Status
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" id="showPermissionGuideBtn">
                    <i class="fas fa-question-circle me-1"></i>Help
                </button>
            </div>
        </div>
        
        <div id="status"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        // Add global toast function
        window.showToast = function(type, title, message, duration = 5000) {
            const backgroundColor = {
                'success': 'linear-gradient(to right, #00b09b, #96c93d)',
                'error': 'linear-gradient(to right, #ff5f6d, #ffc371)',
                'warning': 'linear-gradient(to right, #f093fb, #f5576c)',
                'info': 'linear-gradient(to right, #4facfe, #00f2fe)'
            };

            Toastify({
                text: `${title}\n${message}`,
                duration: duration,
                close: true,
                gravity: "top",
                position: "right",
                style: {
                    background: backgroundColor[type] || backgroundColor.info,
                }
            }).showToast();
        };

        // Mock permission request function
        async function requestNativeBluetoothPermission() {
            console.log('üîí Testing native Bluetooth permission request...');
            
            try {
                const response = await fetch('/api/permissions/request-bluetooth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('üîí Native permission request result:', result);
                
                if (result.success && result.data.permission.granted) {
                    window.showToast('success', '‚úÖ Bluetooth Permission Granted!', 'You can now scan for Bluetooth devices.');
                    document.getElementById('permission-alert').style.display = 'none';
                } else if (result.success && !result.data.permission.granted) {
                    const message = result.data.message || 'Bluetooth permission was not granted';
                    const nextSteps = result.data.nextSteps || result.data.permission.instructions || [];
                    
                    let toastMessage = message;
                    if (nextSteps.length > 0) {
                        toastMessage += '\n\nNext steps:\n‚Ä¢ ' + nextSteps.join('\n‚Ä¢ ');
                    }
                    
                    window.showToast('warning', '‚ö†Ô∏è Permission Not Granted', toastMessage, 8000);
                } else {
                    throw new Error(result.error || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to request native Bluetooth permission:', error);
                
                let errorMessage = 'Failed to request Bluetooth permission from the system.';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Server is not running. Please start the UltiBiker server first.';
                } else {
                    errorMessage += ` Error: ${error.message}`;
                }
                
                window.showToast('error', '‚ùå Permission Request Failed', errorMessage, 8000);
                
                // Update status
                document.getElementById('status').innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Server Connection Failed</h5>
                        <p>To test the permission button, please:</p>
                        <ol>
                            <li>Start the UltiBiker server: <code>npm run dev</code></li>
                            <li>Refresh this page</li>
                            <li>Click the "Grant Permission" button</li>
                        </ol>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        // Test button functionality
        document.addEventListener('DOMContentLoaded', () => {
            const requestBluetoothBtn = document.getElementById('requestBluetoothBtn');
            const checkPermissionsBtn = document.getElementById('checkPermissionsBtn');
            const showPermissionGuideBtn = document.getElementById('showPermissionGuideBtn');
            
            if (requestBluetoothBtn) {
                requestBluetoothBtn.addEventListener('click', async () => {
                    await requestNativeBluetoothPermission();
                });
            }
            
            if (checkPermissionsBtn) {
                checkPermissionsBtn.addEventListener('click', () => {
                    window.showToast('info', '‚ÑπÔ∏è Check Status', 'This would check current permission status');
                });
            }
            
            if (showPermissionGuideBtn) {
                showPermissionGuideBtn.addEventListener('click', () => {
                    window.showToast('info', '‚ÑπÔ∏è Help Guide', 'This would show the permission setup guide');
                });
            }
            
            console.log('‚úÖ Permission button test page loaded');
        });
    </script>
</body>
</html>